# AIチャットボット E2Eテスト仕様書

**プロジェクト名**: AIチャットボット（社内向け汎用対話システム）
**テストフレームワーク**: Playwright
**作成日**: 2025-12-31
**最終更新**: 2025-12-31

---

## テスト環境

### 前提条件
- バックエンドサーバーが起動していること（http://localhost:5001）
- フロントエンドサーバーが起動していること（http://localhost:5173）
- MongoDBが接続可能であること
- Gemini APIキーが正しく設定されていること

### テスト対象ブラウザ
- Chromium
- Firefox
- WebKit (Safari)

### テストデータ
- テスト用スレッドは自動的に作成・削除される
- テスト実行後はクリーンアップを行う

---

## テストカテゴリ

### 1. 初期表示テスト (Initial Display Tests)

#### 1.1 ページロード
- [ ] **Test ID**: `initial-001`
- **テスト名**: ページが正しく読み込まれる
- **手順**:
  1. http://localhost:5173/ にアクセス
  2. ページタイトルを確認
- **期待結果**:
  - ページタイトルが "AIチャット" である
  - エラーが表示されない

#### 1.2 ウェルカム画面表示
- [ ] **Test ID**: `initial-002`
- **テスト名**: スレッド未選択時にウェルカム画面が表示される
- **手順**:
  1. ページにアクセス
  2. メインエリアを確認
- **期待結果**:
  - "AIチャットへようこそ" というメッセージが表示される
  - ウェルカムアイコン（💬）が表示される
  - 案内文が表示される

#### 1.3 スレッド一覧表示
- [ ] **Test ID**: `initial-003`
- **テスト名**: スレッド一覧が表示される
- **手順**:
  1. ページにアクセス
  2. サイドバーを確認
- **期待結果**:
  - "会話履歴" タイトルが表示される
  - "新規会話" ボタンが表示される
  - 既存のスレッドがリスト表示される（存在する場合）

---

### 2. スレッド管理テスト (Thread Management Tests)

#### 2.1 新規スレッド作成
- [ ] **Test ID**: `thread-001`
- **テスト名**: 新規スレッドを作成できる
- **手順**:
  1. "新規会話" ボタンをクリック
  2. スレッド一覧を確認
- **期待結果**:
  - 新しいスレッド "新しい会話" が作成される
  - 作成されたスレッドが選択状態（active）になる
  - URLが `/thread/:threadId` に変わる
  - メインエリアに空のチャット画面が表示される

#### 2.2 スレッド選択
- [ ] **Test ID**: `thread-002`
- **テスト名**: スレッドを選択できる
- **手順**:
  1. スレッド一覧から任意のスレッドをクリック
  2. メインエリアを確認
- **期待結果**:
  - クリックしたスレッドがアクティブになる
  - そのスレッドのメッセージが表示される
  - URLが更新される

#### 2.3 スレッドタイトル編集
- [ ] **Test ID**: `thread-003`
- **テスト名**: スレッドタイトルを編集できる
- **手順**:
  1. スレッドを選択
  2. ヘッダーの編集ボタン（✏️）をクリック
  3. モーダルが表示されることを確認
  4. 新しいタイトルを入力
  5. "保存" ボタンをクリック
- **期待結果**:
  - タイトル編集モーダルが表示される
  - 現在のタイトルが入力欄に表示される
  - 新しいタイトルに更新される
  - スレッド一覧のタイトルも更新される
  - モーダルが閉じる

#### 2.4 スレッドタイトル編集キャンセル
- [ ] **Test ID**: `thread-004`
- **テスト名**: スレッドタイトル編集をキャンセルできる
- **手順**:
  1. スレッドを選択
  2. 編集ボタンをクリック
  3. タイトルを変更
  4. "キャンセル" ボタンをクリック
- **期待結果**:
  - タイトルが変更されない
  - モーダルが閉じる

#### 2.5 スレッド削除確認モーダル
- [ ] **Test ID**: `thread-005`
- **テスト名**: スレッド削除時に確認モーダルが表示される
- **手順**:
  1. スレッド一覧のスレッドにホバー
  2. 削除ボタン（🗑️）が表示されることを確認
  3. 削除ボタンをクリック
- **期待結果**:
  - 削除確認モーダルが表示される
  - "この会話を削除してもよろしいですか？" というメッセージが表示される
  - "この操作は取り消せません。" という警告が表示される
  - "キャンセル" と "削除する" ボタンが表示される

#### 2.6 スレッド削除実行
- [ ] **Test ID**: `thread-006`
- **テスト名**: スレッドを削除できる
- **手順**:
  1. 削除ボタンをクリック
  2. 確認モーダルの "削除する" ボタンをクリック
- **期待結果**:
  - スレッドが一覧から削除される
  - 現在のスレッドだった場合、ホーム画面に戻る
  - バックエンドのデータベースからも削除される

#### 2.7 スレッド削除キャンセル
- [ ] **Test ID**: `thread-007`
- **テスト名**: スレッド削除をキャンセルできる
- **手順**:
  1. 削除ボタンをクリック
  2. 確認モーダルの "キャンセル" ボタンをクリック
- **期待結果**:
  - スレッドが削除されない
  - モーダルが閉じる

---

### 3. メッセージ送受信テスト (Message Tests)

#### 3.1 メッセージ入力
- [ ] **Test ID**: `message-001`
- **テスト名**: メッセージを入力できる
- **手順**:
  1. スレッドを選択または作成
  2. 入力欄にテキストを入力
- **期待結果**:
  - テキストが入力欄に表示される
  - テキストエリアの高さが自動調整される
  - 送信ボタンが有効になる

#### 3.2 メッセージ送信（Enterキー）
- [ ] **Test ID**: `message-002`
- **テスト名**: Enterキーでメッセージを送信できる
- **手順**:
  1. 入力欄にテキストを入力
  2. Enterキーを押す
- **期待結果**:
  - メッセージが送信される
  - 入力欄がクリアされる
  - ユーザーメッセージがチャットに表示される
  - ローディング状態が表示される
  - AI応答が表示される

#### 3.3 メッセージ送信（送信ボタン）
- [ ] **Test ID**: `message-003`
- **テスト名**: 送信ボタンでメッセージを送信できる
- **手順**:
  1. 入力欄にテキストを入力
  2. 送信ボタンをクリック
- **期待結果**:
  - メッセージが送信される
  - 入力欄がクリアされる
  - ユーザーメッセージとAI応答が表示される

#### 3.4 改行入力（Shift+Enter）
- [ ] **Test ID**: `message-004`
- **テスト名**: Shift+Enterで改行できる
- **手順**:
  1. 入力欄にテキストを入力
  2. Shift+Enterを押す
  3. さらにテキストを入力
- **期待結果**:
  - メッセージが送信されない
  - 改行が入力される
  - 複数行のテキストを入力できる

#### 3.5 空メッセージの送信防止
- [ ] **Test ID**: `message-005`
- **テスト名**: 空のメッセージは送信できない
- **手順**:
  1. 入力欄が空の状態で送信ボタンをクリック
  2. 空白のみを入力して送信
- **期待結果**:
  - メッセージが送信されない
  - 送信ボタンが無効状態である

#### 3.6 メッセージ表示
- [ ] **Test ID**: `message-006`
- **テスト名**: ユーザーとAIのメッセージが区別して表示される
- **手順**:
  1. メッセージを送信
  2. 表示されたメッセージを確認
- **期待結果**:
  - ユーザーメッセージに "You" ラベルが表示される
  - AIメッセージに "AI Assistant" ラベルが表示される
  - アバターアイコンが表示される（👤 / 🤖）
  - タイムスタンプが表示される
  - 異なるスタイルで区別される

#### 3.7 AI応答受信
- [ ] **Test ID**: `message-007`
- **テスト名**: AI（Gemini）から応答を受信できる
- **手順**:
  1. 「こんにちは」というメッセージを送信
  2. AI応答を待つ
- **期待結果**:
  - AI応答が表示される
  - 応答内容が適切である
  - ローディング状態が解除される

#### 3.8 連続メッセージ送信
- [ ] **Test ID**: `message-008`
- **テスト名**: 複数のメッセージを連続で送信できる
- **手順**:
  1. メッセージ1を送信
  2. AI応答を待つ
  3. メッセージ2を送信
  4. AI応答を待つ
- **期待結果**:
  - 全てのメッセージが正しい順序で表示される
  - 会話履歴が保持される
  - スクロールが最新メッセージに追従する

---

### 4. Markdownレンダリングテスト (Markdown Rendering Tests)

#### 4.1 見出しのレンダリング
- [ ] **Test ID**: `markdown-001`
- **テスト名**: Markdown見出しが正しく表示される
- **手順**:
  1. "# 見出し1\n## 見出し2\n### 見出し3" というメッセージを送信
  2. AI応答を確認
- **期待結果**:
  - H1, H2, H3タグが正しくレンダリングされる
  - 適切なスタイルが適用される

#### 4.2 リストのレンダリング
- [ ] **Test ID**: `markdown-002`
- **テスト名**: Markdownリストが正しく表示される
- **手順**:
  1. "箇条書きと番号付きリストを表示して" とメッセージを送信
  2. AI応答を確認
- **期待結果**:
  - 箇条書きリスト（ul/li）が正しく表示される
  - 番号付きリスト（ol/li）が正しく表示される

#### 4.3 リンクのレンダリング
- [ ] **Test ID**: `markdown-003`
- **テスト名**: Markdownリンクが正しく表示される
- **手順**:
  1. "リンクを含むメッセージを表示して" とメッセージを送信
  2. AI応答内のリンクを確認
- **期待結果**:
  - リンクがクリック可能な状態で表示される
  - リンクのスタイルが適用される

#### 4.4 コードブロックのレンダリング
- [ ] **Test ID**: `markdown-004`
- **テスト名**: コードブロックが正しく表示される
- **手順**:
  1. "Pythonのサンプルコードを表示して" とメッセージを送信
  2. AI応答のコードブロックを確認
- **期待結果**:
  - コードブロックが専用のスタイルで表示される
  - 言語名が表示される
  - シンタックスハイライトが適用される
  - コピーボタンが表示される

#### 4.5 インラインコードのレンダリング
- [ ] **Test ID**: `markdown-005`
- **テスト名**: インラインコードが正しく表示される
- **手順**:
  1. "`console.log('hello')` のようなコードを説明して" とメッセージを送信
  2. AI応答を確認
- **期待結果**:
  - インラインコードが背景色付きで表示される
  - 等幅フォントが適用される

#### 4.6 コピーボタン機能
- [ ] **Test ID**: `markdown-006`
- **テスト名**: コードブロックのコピーボタンが動作する
- **手順**:
  1. コードブロックを含むAI応答を取得
  2. コピーボタンをクリック
  3. ボタンの状態を確認
- **期待結果**:
  - コピーボタンをクリックできる
  - ボタンのテキストが "Copy" から "Copied!" に変わる
  - 2秒後に "Copy" に戻る
  - クリップボードにコードがコピーされる

#### 4.7 複数のコードブロック
- [ ] **Test ID**: `markdown-007`
- **テスト名**: 複数のコードブロックを含むメッセージを表示できる
- **手順**:
  1. "PythonとJavaScriptのサンプルコードを両方表示して" とメッセージを送信
  2. AI応答を確認
- **期待結果**:
  - 複数のコードブロックが個別に表示される
  - それぞれに異なる言語のハイライトが適用される
  - それぞれにコピーボタンが表示される

#### 4.8 表のレンダリング
- [ ] **Test ID**: `markdown-008`
- **テスト名**: Markdown表が正しく表示される
- **手順**:
  1. "簡単な表を作成して" とメッセージを送信
  2. AI応答を確認
- **期待結果**:
  - HTMLのtableタグでレンダリングされる
  - 適切なスタイルが適用される

---

### 5. UI/UXテスト (UI/UX Tests)

#### 5.1 ローディング状態（メッセージ送信中）
- [ ] **Test ID**: `ui-001`
- **テスト名**: メッセージ送信中のローディング状態が表示される
- **手順**:
  1. メッセージを送信
  2. AI応答を待つ間の状態を確認
- **期待結果**:
  - 送信ボタンにローディングアイコン（⏳）が表示される
  - 入力欄が無効化される
  - 送信ボタンが無効化される

#### 5.2 ローディング状態（スレッド読み込み中）
- [ ] **Test ID**: `ui-002`
- **テスト名**: スレッド読み込み中のローディング状態が表示される
- **手順**:
  1. ページを再読み込み
  2. スレッド一覧の読み込み状態を確認
- **期待結果**:
  - "読み込み中..." というメッセージが表示される
  - または適切なローディングインジケーターが表示される

#### 5.3 空状態の表示
- [ ] **Test ID**: `ui-003`
- **テスト名**: メッセージがない場合の空状態が表示される
- **手順**:
  1. 新規スレッドを作成
  2. メインエリアを確認
- **期待結果**:
  - "まだメッセージがありません" というメッセージが表示される
  - "下のフォームからメッセージを送信してみましょう" というヒントが表示される

#### 5.4 自動スクロール
- [ ] **Test ID**: `ui-004`
- **テスト名**: 新しいメッセージが追加されると自動スクロールする
- **手順**:
  1. 複数のメッセージを送信
  2. スクロール位置を確認
- **期待結果**:
  - 新しいメッセージが表示されると自動的に最下部にスクロールする
  - 最新のメッセージが常に表示される

#### 5.5 エラーメッセージ表示
- [ ] **Test ID**: `ui-005`
- **テスト名**: エラー発生時にエラーメッセージが表示される
- **手順**:
  1. バックエンドサーバーを停止
  2. メッセージを送信
  3. エラーメッセージを確認
- **期待結果**:
  - エラーメッセージが表示される
  - ユーザーにわかりやすいメッセージである
  - 5秒後に自動的に消える

#### 5.6 レスポンシブデザイン（モバイル）
- [ ] **Test ID**: `ui-006`
- **テスト名**: モバイルビューでサイドバーが隠れる
- **手順**:
  1. ブラウザの幅を768px以下にリサイズ
  2. レイアウトを確認
- **期待結果**:
  - サイドバーが非表示になる
  - ハンバーガーメニュー（☰）が表示される
  - メインエリアが全幅になる

#### 5.7 レスポンシブデザイン（モバイルメニュー）
- [ ] **Test ID**: `ui-007`
- **テスト名**: モバイルビューでサイドバーを開閉できる
- **手順**:
  1. モバイルビューでハンバーガーメニューをクリック
  2. サイドバーの表示を確認
  3. スレッドを選択
- **期待結果**:
  - サイドバーがスライドインして表示される
  - スレッド選択後、サイドバーが自動的に閉じる
  - オーバーレイが表示される

#### 5.8 時刻表示フォーマット
- [ ] **Test ID**: `ui-008`
- **テスト名**: タイムスタンプが正しいフォーマットで表示される
- **手順**:
  1. メッセージを送信
  2. タイムスタンプを確認
- **期待結果**:
  - "HH:MM" 形式で表示される（例: 14:30）
  - 日本語ロケールで表示される

#### 5.9 相対時間表示
- [ ] **Test ID**: `ui-009`
- **テスト名**: スレッド一覧の更新日時が相対表示される
- **手順**:
  1. スレッド一覧を確認
  2. 各スレッドの時刻表示を確認
- **期待結果**:
  - "たった今", "5分前", "2時間前" などの相対表示
  - 1週間以上前の場合は日付表示

---

### 6. 統合フローテスト (Integration Flow Tests)

#### 6.1 新規会話の完全フロー
- [ ] **Test ID**: `flow-001`
- **テスト名**: 新規会話を作成してメッセージを送信する完全フロー
- **手順**:
  1. ページにアクセス
  2. "新規会話" ボタンをクリック
  3. 「こんにちは」とメッセージを送信
  4. AI応答を受信
  5. 「ありがとう」とメッセージを送信
  6. AI応答を受信
- **期待結果**:
  - 全ての操作がスムーズに実行される
  - 会話履歴が正しく保存される
  - スレッドが一覧に表示される

#### 6.2 スレッド切り替えフロー
- [ ] **Test ID**: `flow-002`
- **テスト名**: スレッドを切り替えて過去のメッセージを表示
- **手順**:
  1. スレッドAを選択
  2. メッセージを送信
  3. スレッドBを選択
  4. メッセージを送信
  5. スレッドAに戻る
- **期待結果**:
  - スレッドAの過去のメッセージが表示される
  - スレッドBのメッセージは表示されない
  - 各スレッドの状態が正しく保持される

#### 6.3 スレッド削除フロー
- [ ] **Test ID**: `flow-003`
- **テスト名**: スレッドを削除して確認
- **手順**:
  1. 新規スレッドを作成
  2. メッセージを送信
  3. スレッドを削除
  4. スレッド一覧を確認
- **期待結果**:
  - スレッドが一覧から削除される
  - ホーム画面に戻る
  - 削除されたスレッドにアクセスできない

#### 6.4 タイトル編集フロー
- [ ] **Test ID**: `flow-004`
- **テスト名**: スレッドタイトルを編集して保存
- **手順**:
  1. スレッドを選択
  2. タイトル編集ボタンをクリック
  3. "テストタイトル" と入力
  4. 保存
  5. ページを再読み込み
- **期待結果**:
  - タイトルが "テストタイトル" に変更される
  - 再読み込み後も変更が保持される
  - スレッド一覧のタイトルも更新される

#### 6.5 長い会話のフロー
- [ ] **Test ID**: `flow-005`
- **テスト名**: 10回以上のメッセージ交換を行う
- **手順**:
  1. 新規スレッドを作成
  2. 10回以上メッセージを送信
  3. スクロール動作を確認
  4. 最初のメッセージまでスクロール
- **期待結果**:
  - 全てのメッセージが正しく表示される
  - スクロールがスムーズに動作する
  - パフォーマンスの問題がない

#### 6.6 Markdownを含む会話フロー
- [ ] **Test ID**: `flow-006`
- **テスト名**: Markdownとコードを含む会話を実施
- **手順**:
  1. "Pythonの関数について説明して"
  2. "サンプルコードも含めて"
  3. コードブロックをコピー
  4. 別のメッセージを送信
- **期待結果**:
  - 全てのMarkdownが正しくレンダリングされる
  - コードのコピーが正常に動作する
  - 会話の流れが自然である

#### 6.7 複数スレッドの並行操作
- [ ] **Test ID**: `flow-007`
- **テスト名**: 複数のスレッドを作成して切り替える
- **手順**:
  1. スレッドA, B, Cを作成
  2. 各スレッドにメッセージを送信
  3. スレッド間を切り替え
  4. 各スレッドのメッセージを確認
- **期待結果**:
  - 各スレッドが独立して管理される
  - メッセージが混在しない
  - スレッド切り替えがスムーズ

#### 6.8 エラーリカバリーフロー
- [ ] **Test ID**: `flow-008`
- **テスト名**: エラー発生後の復旧
- **手順**:
  1. バックエンドサーバーを一時停止
  2. メッセージを送信（エラー発生）
  3. バックエンドサーバーを再起動
  4. メッセージを再送信
- **期待結果**:
  - エラーメッセージが表示される
  - サーバー復旧後は正常に動作する
  - データの整合性が保たれる

---

### 7. パフォーマンステスト (Performance Tests)

#### 7.1 初期ロード時間
- [ ] **Test ID**: `perf-001`
- **テスト名**: 初期ページロードが3秒以内
- **測定項目**:
  - DOMContentLoaded
  - Load イベント
  - First Contentful Paint
- **期待結果**: 全て3秒以内

#### 7.2 スレッド切り替え速度
- [ ] **Test ID**: `perf-002`
- **テスト名**: スレッド切り替えが1秒以内
- **測定項目**:
  - クリックからメッセージ表示まで
- **期待結果**: 1秒以内

#### 7.3 メッセージ送信レスポンス
- [ ] **Test ID**: `perf-003`
- **テスト名**: メッセージ送信のUI反応が即座
- **測定項目**:
  - 送信ボタンクリックからUI更新まで
- **期待結果**: 100ms以内

---

### 8. アクセシビリティテスト (Accessibility Tests)

#### 8.1 キーボード操作
- [ ] **Test ID**: `a11y-001`
- **テスト名**: キーボードのみで全機能を操作できる
- **手順**:
  1. Tabキーで要素を移動
  2. Enterキーでボタンをクリック
  3. 全ての機能を試す
- **期待結果**: マウスなしで全機能が使用可能

#### 8.2 フォーカス表示
- [ ] **Test ID**: `a11y-002`
- **テスト名**: フォーカス状態が視覚的に明確
- **手順**:
  1. Tabキーで要素を移動
  2. フォーカスリングを確認
- **期待結果**: 現在のフォーカス位置が明確に表示される

#### 8.3 ARIAラベル
- [ ] **Test ID**: `a11y-003`
- **テスト名**: 重要な要素にARIAラベルがある
- **確認項目**:
  - ボタン
  - 入力欄
  - ナビゲーション
- **期待結果**: 適切なARIA属性が設定されている

---

### 9. セキュリティテスト (Security Tests)

#### 9.1 XSS対策（Markdown）
- [ ] **Test ID**: `sec-001`
- **テスト名**: MarkdownレンダリングでXSSが防止される
- **手順**:
  1. `<script>alert('XSS')</script>` を含むメッセージを送信
  2. レンダリング結果を確認
- **期待結果**: スクリプトが実行されず、サニタイズされる

#### 9.2 XSS対策（リンク）
- [ ] **Test ID**: `sec-002`
- **テスト名**: 悪意のあるリンクが防止される
- **手順**:
  1. `javascript:alert('XSS')` を含むリンクを送信
  2. レンダリング結果を確認
- **期待結果**: JavaScriptリンクが無効化される

---

## テスト実行方法

### 1. セットアップ
```bash
# Playwrightのインストール
npm install -D @playwright/test
npx playwright install

# テストディレクトリ作成
mkdir -p tests/e2e
```

### 2. テスト実行
```bash
# 全てのテストを実行
npx playwright test

# 特定のテストファイルを実行
npx playwright test tests/e2e/thread-management.spec.js

# UIモードで実行
npx playwright test --ui

# デバッグモード
npx playwright test --debug

# 特定のブラウザで実行
npx playwright test --project=chromium
npx playwright test --project=firefox
npx playwright test --project=webkit
```

### 3. レポート確認
```bash
# HTMLレポートを開く
npx playwright show-report
```

---

## テストデータ管理

### テスト前のクリーンアップ
- テスト用のスレッドは `[TEST]` プレフィックスを付ける
- テスト終了後は作成したデータを削除する
- `beforeEach` でクリーンな状態を確保

### テスト用ヘルパー関数
```javascript
// テスト用スレッド作成
async function createTestThread(page, title = '[TEST] テストスレッド') {
  // 実装...
}

// テスト用データのクリーンアップ
async function cleanupTestData(page) {
  // 実装...
}
```

---

## CI/CD統合

### GitHub Actions設定例
```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - name: Install dependencies
        run: npm ci
      - name: Start servers
        run: |
          npm run dev &
          cd api && uv run python index.py &
      - name: Run Playwright tests
        run: npx playwright test
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
```

---

## トラブルシューティング

### よくある問題

1. **タイムアウトエラー**
   - AI応答待ちの時間を増やす
   - `test.setTimeout(60000)` を設定

2. **要素が見つからない**
   - ローディング完了を待つ
   - `page.waitForSelector()` を使用

3. **不安定なテスト**
   - 適切な待機条件を追加
   - `page.waitForLoadState('networkidle')` を使用

---

## 完了基準

全てのテストが以下の条件を満たすこと:
- [ ] 全テストがパスする
- [ ] 3つのブラウザで動作する
- [ ] カバレッジが80%以上
- [ ] CI/CDパイプラインで自動実行される
- [ ] テスト実行時間が5分以内

---

## 備考

- テストは独立して実行可能であること
- テストの実行順序に依存しないこと
- 定期的にテストを見直し、更新すること
- 新機能追加時は対応するテストも追加すること
